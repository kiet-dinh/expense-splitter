---
phase: 02-core-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - gsd-module-test/src/store/billStore.ts
  - gsd-module-test/src/store/billStore.test.ts
  - gsd-module-test/src/store/computeResults.ts
  - gsd-module-test/src/store/computeResults.test.ts
  - gsd-module-test/vitest.config.ts
  - gsd-module-test/vitest.setup.ts
  - gsd-module-test/package.json
autonomous: true
requirements:
  - PEOPLE-01
  - PEOPLE-02
  - PEOPLE-03
  - ITEM-01
  - ITEM-02
  - ITEM-03
  - ASSIGN-01
  - ASSIGN-02
  - ASSIGN-03
  - ASSIGN-04
  - TIP-01
  - TIP-02
  - TAX-01
  - TAX-02

must_haves:
  truths:
    - "Zustand store holds people, items, assignments, tip settings, and tax settings"
    - "Adding a person creates a record with a unique UUID id"
    - "Removing a person cascades to clean up all assignments referencing that person"
    - "Removing an item removes its assignment entry"
    - "computeResults returns correct per-person breakdown with zero grandTotalCheck"
    - "All-zero proportional weights fall back to equal distribution without NaN"
  artifacts:
    - path: "gsd-module-test/src/store/billStore.ts"
      provides: "Zustand store with all state and actions"
      exports: ["useBillStore", "Person", "Item", "Assignment", "ItemAssignment"]
    - path: "gsd-module-test/src/store/computeResults.ts"
      provides: "Pure computation function for bill results"
      exports: ["computeResults", "PersonResult", "BillResults"]
    - path: "gsd-module-test/src/store/billStore.test.ts"
      provides: "Store action unit tests"
      min_lines: 50
    - path: "gsd-module-test/src/store/computeResults.test.ts"
      provides: "Computation function unit tests"
      min_lines: 40
    - path: "gsd-module-test/vitest.setup.ts"
      provides: "Test setup with jest-dom matchers for component tests"
      contains: "@testing-library/jest-dom/vitest"
  key_links:
    - from: "gsd-module-test/src/store/computeResults.ts"
      to: "gsd-module-test/src/engine/math.ts"
      via: "import { distribute } from '../engine/math'"
      pattern: "import.*distribute.*from.*engine/math"
    - from: "gsd-module-test/src/store/billStore.ts"
      to: "crypto.randomUUID()"
      via: "UUID generation for people and items"
      pattern: "crypto\\.randomUUID"
---

<objective>
Create the Zustand store (data model + all actions), the computeResults pure function (calculation engine integration), and the test infrastructure for Phase 2 component testing.

Purpose: The store defines ALL data contracts downstream UI plans depend on. The computeResults function bridges the Phase 1 calculation engine to the UI layer. Test infra (jsdom, RTL, jest-dom) enables component testing in subsequent plans.

Output: billStore.ts, computeResults.ts, their test files, updated vitest config, and test setup file.
</objective>

<execution_context>
@C:/Users/Kiet Dinh/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Kiet Dinh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@gsd-module-test/src/engine/math.ts
@gsd-module-test/vitest.config.ts
@gsd-module-test/package.json
@.planning/phases/02-core-ui/02-RESEARCH.md (Pattern 1: Zustand Store, Pattern 2: computeResults, Pattern 3: Vitest Config)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install test dependencies and configure Vitest for component testing</name>
  <files>
    gsd-module-test/package.json
    gsd-module-test/vitest.config.ts
    gsd-module-test/vitest.setup.ts
  </files>
  <action>
    1. Install dev dependencies:
       ```bash
       cd gsd-module-test && npm install -D jsdom @testing-library/react @testing-library/jest-dom @testing-library/user-event
       ```

    2. Update `vitest.config.ts` to include the React plugin and setup file:
       ```typescript
       import { defineConfig } from 'vitest/config'
       import react from '@vitejs/plugin-react'

       export default defineConfig({
         plugins: [react()],
         test: {
           environment: 'node',
           passWithNoTests: true,
           setupFiles: ['./vitest.setup.ts'],
         },
       })
       ```
       - `environment: 'node'` remains the default — component tests use per-file `// @vitest-environment jsdom` directive
       - `plugins: [react()]` is required or component tests fail with "React is not defined"
       - `setupFiles` loads jest-dom matchers globally

    3. Create `vitest.setup.ts`:
       ```typescript
       import '@testing-library/jest-dom/vitest'
       ```
       - MUST use `/vitest` entry point, NOT the bare `@testing-library/jest-dom` (which targets Jest)

    4. Verify existing Phase 1 tests still pass: `cd gsd-module-test && npx vitest run`
  </action>
  <verify>
    - `npx vitest run` passes all 28 existing engine tests
    - `vitest.setup.ts` exists and imports jest-dom/vitest
    - `vitest.config.ts` includes react plugin and setupFiles
    - `package.json` devDependencies include jsdom, @testing-library/react, @testing-library/jest-dom, @testing-library/user-event
  </verify>
  <done>Test infrastructure ready for both node-environment store tests and jsdom-environment component tests. All 28 Phase 1 tests still pass.</done>
</task>

<task type="auto">
  <name>Task 2: Create Zustand store with types, actions, and computeResults function</name>
  <files>
    gsd-module-test/src/store/billStore.ts
    gsd-module-test/src/store/billStore.test.ts
    gsd-module-test/src/store/computeResults.ts
    gsd-module-test/src/store/computeResults.test.ts
  </files>
  <action>
    **Create `src/store/billStore.ts`** with the full Zustand store following Pattern 1 from research:

    Types to export:
    - `Person` — `{ id: string; name: string }`
    - `Item` — `{ id: string; name: string; priceCents: number }`
    - `Assignment` — discriminated union: `unassigned | single | equal | everyone | custom`
      - `{ mode: 'unassigned' }`
      - `{ mode: 'single'; personId: string }`
      - `{ mode: 'equal'; personIds: string[] }`
      - `{ mode: 'everyone' }`
      - `{ mode: 'custom'; portions: { personId: string; weight: number }[] }`
    - `ItemAssignment` — `{ itemId: string; assignment: Assignment }`
    - `TipSplitMode` — `'equal' | 'proportional'`
    - `TaxMode` — `'amount' | 'percent'`
    - `TaxSplitMode` — `'equal' | 'proportional'`

    Store state: `people`, `items`, `assignments`, `tipPercent` (default 0), `tipSplitMode` (default 'equal'), `taxMode` (default 'amount'), `taxValue` (default 0), `taxSplitMode` (default 'equal')

    Actions:
    - `addPerson(name)` — trims name, creates `{ id: crypto.randomUUID(), name: name.trim() }`
    - `removePerson(id)` — filters people AND cascades to assignments:
      - `single` with matching personId → set to `unassigned`
      - `equal` → filter personIds; empty → `unassigned`
      - `custom` → filter portions; empty → `unassigned`
      - `everyone` → no change (still everyone, just fewer people)
    - `addItem(name, priceCents)` — creates item with `crypto.randomUUID()`
    - `updateItem(id, changes: Partial<Pick<Item, 'name' | 'priceCents'>>)` — merges changes
    - `removeItem(id)` — filters items AND removes assignment entry for that item
    - `setAssignment(itemId, assignment)` — upsert: update existing or add new
    - `setTipPercent(percent)`, `setTipSplitMode(mode)`, `setTaxMode(mode)`, `setTaxValue(value)`, `setTaxSplitMode(mode)`

    Use `create<BillState>()((set) => ({...}))` curried syntax (Zustand v5 TypeScript pattern).

    **Create `src/store/computeResults.ts`** following Pattern 2 from research:

    Export types: `PersonResult`, `BillResults`
    Export function: `computeResults(people, items, assignments, tipPercent, tipSplitMode, taxMode, taxValue, taxSplitMode)`

    Logic:
    1. Early return for empty people → all zeros
    2. Build `personSubtotals` Map from assignments (handle all 5 modes)
    3. Compute `subtotalCents` = sum of person subtotals (NOT sum of all items — only assigned items count)
    4. Compute `tipCents` = `Math.round(subtotalCents * tipPercent / 100)`
    5. Build tip weights (proportional = person subtotals, equal = uniform 1s); guard all-zero → fall back to equal
    6. `tipShares = distribute(tipCents, safeWeights)`
    7. Compute `taxCents` — if `taxMode === 'amount'` use `taxValue` directly; if `'percent'` use `Math.round(subtotalCents * taxValue / 100)`
    8. Build tax weights same pattern; `taxShares = distribute(taxCents, safeTaxWeights)`
    9. Build `perPerson` array with subtotal, tip, tax, total per person
    10. `grandTotalCheck = grandTotalCents - sum(person.totalCents)` — should always be 0
    11. Import `distribute` from `'../engine/math'` — do NOT import centsToDollars (display is UI's job)

    **Create `src/store/billStore.test.ts`** (node environment — no jsdom directive):

    Tests (import `describe, it, expect, beforeEach` from `vitest`):
    - `beforeEach` resets store with `useBillStore.setState({...defaults})`
    - `addPerson`: adds person with unique id, trimmed name
    - `addPerson` twice: two different ids
    - `removePerson`: person removed from people array
    - `removePerson cascades single assignment`: assignment becomes unassigned
    - `removePerson cascades equal assignment`: personId filtered; empty → unassigned
    - `removePerson cascades custom assignment`: portion filtered; empty → unassigned
    - `addItem`: adds item with id and priceCents
    - `updateItem`: changes name and/or price
    - `removeItem`: item removed, assignment for item removed
    - `setAssignment`: upsert works for new and existing
    - Tip/tax setters: each setter updates its field

    **Create `src/store/computeResults.test.ts`** (node environment):

    Tests:
    - Empty people → all zeros
    - Single item assigned to single person → correct subtotal, no tip/tax
    - Item split equally between 2 people → shares sum to item price
    - Item with custom portions (2:1 ratio) → correct distribution
    - Everyone mode → distributed across all people
    - Unassigned item excluded from totals
    - Tip at 20% proportional → distributed by person subtotals
    - Tip at 18% equal → distributed uniformly
    - Tax as dollar amount → distributed correctly
    - Tax as percentage → computed and distributed
    - All-zero subtotals with proportional tip → falls back to equal (no NaN)
    - grandTotalCheck is always 0 in all tests
  </action>
  <verify>
    - `cd gsd-module-test && npx vitest run` passes ALL tests (28 engine + new store + computeResults tests)
    - `npx tsc --noEmit` passes with no type errors
    - billStore.ts exports useBillStore and all types
    - computeResults.ts imports distribute from engine/math
  </verify>
  <done>Zustand store with all actions and cascading cleanup implemented. computeResults pure function correctly computes per-person breakdown. All store and computation tests pass. All Phase 1 engine tests still pass.</done>
</task>

</tasks>

<verification>
1. `cd gsd-module-test && npx vitest run` — all tests pass (engine + store + computeResults)
2. `cd gsd-module-test && npx tsc --noEmit` — no type errors
3. `cd gsd-module-test && npm run build` — builds without errors
4. billStore.ts exports: useBillStore, Person, Item, Assignment, ItemAssignment, TipSplitMode, TaxMode, TaxSplitMode
5. computeResults.ts exports: computeResults, PersonResult, BillResults
6. vitest.setup.ts imports @testing-library/jest-dom/vitest
7. vitest.config.ts includes react plugin and setupFiles
</verification>

<success_criteria>
- Zustand store is the single source of truth for all bill data
- Every store action is unit-tested including cascading cleanup
- computeResults is a pure function (no side effects, no store dependency)
- computeResults handles all 5 assignment modes, tip, tax, and edge cases
- Test infrastructure supports both node and jsdom environments
- All Phase 1 tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-ui/02-01-SUMMARY.md`
</output>
