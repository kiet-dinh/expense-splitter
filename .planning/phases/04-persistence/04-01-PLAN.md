---
phase: 04-persistence
plan: 1
type: execute
wave: 1
depends_on: []
files_modified:
  - gsd-module-test/src/store/historyStore.ts
autonomous: true
requirements:
  - PERSIST-01

must_haves:
  truths:
    - "A saved split written via saveSplit() survives a page reload (data is in localStorage under key 'bill-splitter-history')"
    - "deleteSplit(id) removes the entry from savedSplits immediately"
    - "saveSplit() stores all intent fields: people, items, assignments, tipPercent, tipSplitMode, taxMode, taxValue, taxSplitMode"
    - "useBillStore is NOT wrapped with persist — starting the app always begins with an empty bill"
  artifacts:
    - path: "gsd-module-test/src/store/historyStore.ts"
      provides: "useHistoryStore with persist middleware, SavedSplit interface, saveSplit and deleteSplit actions"
      exports:
        - useHistoryStore
        - SavedSplit
        - CURRENT_SCHEMA_VERSION
  key_links:
    - from: "gsd-module-test/src/store/historyStore.ts"
      to: "localStorage"
      via: "Zustand persist middleware with createJSONStorage"
      pattern: "createJSONStorage.*localStorage"
    - from: "gsd-module-test/src/store/historyStore.ts"
      to: "gsd-module-test/src/store/billStore.ts"
      via: "Type imports for Person, Item, ItemAssignment, TipSplitMode, TaxMode, TaxSplitMode"
      pattern: "import type.*billStore"
---

<objective>
Create the persisted history store that is the data foundation for all Phase 4 features.

Purpose: All save/load/delete operations in Phase 4 go through useHistoryStore. Creating it first as a standalone data layer lets the UI plans (04-02 and 04-03) proceed in parallel without coordination.
Output: src/store/historyStore.ts with SavedSplit interface, useHistoryStore (Zustand persist middleware), saveSplit and deleteSplit actions, schema versioning.
</objective>

<execution_context>
@C:/Users/Kiet Dinh/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Kiet Dinh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-persistence/04-RESEARCH.md
@gsd-module-test/src/store/billStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create historyStore.ts with Zustand persist middleware</name>
  <files>gsd-module-test/src/store/historyStore.ts</files>
  <action>
Create gsd-module-test/src/store/historyStore.ts. The file must contain exactly:

1. Imports:
   - `create` from `'zustand'`
   - `persist, createJSONStorage` from `'zustand/middleware'`
   - Type imports from `'./billStore'`: `Person`, `Item`, `ItemAssignment`, `TipSplitMode`, `TaxMode`, `TaxSplitMode`

2. Export `CURRENT_SCHEMA_VERSION = 1` (const number)

3. Export `SavedSplit` interface with fields:
   - `id: string` (crypto.randomUUID())
   - `name: string` (user-chosen label)
   - `savedAt: string` (ISO 8601 timestamp)
   - `schemaVersion: number`
   - `people: Person[]`
   - `items: Item[]`
   - `assignments: ItemAssignment[]`
   - `tipPercent: number`
   - `tipSplitMode: TipSplitMode`
   - `taxMode: TaxMode`
   - `taxValue: number`
   - `taxSplitMode: TaxSplitMode`

4. Internal `HistoryState` interface:
   - `savedSplits: SavedSplit[]`
   - `saveSplit: (data: Omit<SavedSplit, 'id' | 'savedAt' | 'schemaVersion'>) => void`
   - `deleteSplit: (id: string) => void`

5. Export `useHistoryStore = create<HistoryState>()(persist(...))` with:
   - `savedSplits: []` initial state
   - `saveSplit`: prepends new split (newest-first) with `crypto.randomUUID()`, `new Date().toISOString()`, `schemaVersion: CURRENT_SCHEMA_VERSION`
   - `deleteSplit`: filters out entry by id
   - Persist options:
     - `name: 'bill-splitter-history'`
     - `storage: createJSONStorage(() => localStorage)`
     - `version: CURRENT_SCHEMA_VERSION`
     - `partialize: (state) => ({ savedSplits: state.savedSplits })` — excludes action functions from JSON
     - `migrate: (persistedState, _version) => persistedState as HistoryState` — v1 baseline; future migrations added here

Do NOT modify billStore.ts. Do NOT add persist middleware to useBillStore.

Reference the exact code pattern in 04-RESEARCH.md "Full HistoryStore Definition" section.
  </action>
  <verify>
Run from gsd-module-test directory:
```
npx tsc --noEmit
npx vitest run
```
TypeScript must compile with 0 errors. All existing tests must still pass (128/128).
  </verify>
  <done>
- gsd-module-test/src/store/historyStore.ts exists and exports `useHistoryStore`, `SavedSplit`, `CURRENT_SCHEMA_VERSION`
- `npx tsc --noEmit` exits 0
- `npx vitest run` passes all existing tests
- billStore.ts is unmodified
  </done>
</task>

</tasks>

<verification>
From gsd-module-test directory:
1. `npx tsc --noEmit` — 0 type errors
2. `npx vitest run` — all tests pass (128+)
3. Check historyStore.ts exports: `grep -n "export" gsd-module-test/src/store/historyStore.ts` should show `useHistoryStore`, `SavedSplit`, `CURRENT_SCHEMA_VERSION`
4. Confirm billStore.ts unchanged: `git diff gsd-module-test/src/store/billStore.ts` should show no changes
</verification>

<success_criteria>
- historyStore.ts created with correct TypeScript types and Zustand persist configuration
- No regressions in existing 128 tests
- 0 TypeScript errors
- useBillStore remains ephemeral (not persisted)
</success_criteria>

<output>
After completion, create `.planning/phases/04-persistence/04-01-SUMMARY.md`
</output>
