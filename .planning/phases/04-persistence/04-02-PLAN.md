---
phase: 04-persistence
plan: 2
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - gsd-module-test/src/components/HistorySection.tsx
  - gsd-module-test/src/components/HistorySection.test.tsx
  - gsd-module-test/src/App.tsx
autonomous: true
requirements:
  - PERSIST-02
  - PERSIST-03

must_haves:
  truths:
    - "When no splits are saved, HistorySection renders 'No saved splits yet'"
    - "When splits exist, each entry shows its name and formatted save date"
    - "Clicking Load on a history entry calls useBillStore.setState() with that split's data, replacing the current bill"
    - "Clicking Load shows a browser confirm() if the current bill already has people or items"
    - "Clicking Delete on an entry removes it from the list immediately"
    - "HistorySection is rendered in App.tsx below ResultsSection"
  artifacts:
    - path: "gsd-module-test/src/components/HistorySection.tsx"
      provides: "History list UI with load and delete per entry"
      exports:
        - HistorySection
    - path: "gsd-module-test/src/components/HistorySection.test.tsx"
      provides: "Component tests covering empty state, list render, load, confirm-on-load, and delete"
    - path: "gsd-module-test/src/App.tsx"
      provides: "HistorySection mounted below ResultsSection"
  key_links:
    - from: "gsd-module-test/src/components/HistorySection.tsx"
      to: "gsd-module-test/src/store/historyStore.ts"
      via: "useHistoryStore for savedSplits and deleteSplit"
      pattern: "useHistoryStore"
    - from: "gsd-module-test/src/components/HistorySection.tsx"
      to: "gsd-module-test/src/store/billStore.ts"
      via: "useBillStore.setState() for loading a split"
      pattern: "useBillStore\\.setState"
    - from: "gsd-module-test/src/App.tsx"
      to: "gsd-module-test/src/components/HistorySection.tsx"
      via: "import and JSX mount"
      pattern: "<HistorySection"
---

<objective>
Build the HistorySection component (list, load, delete) and wire it into App.tsx.

Purpose: This delivers PERSIST-02 (view saved splits) and PERSIST-03 (delete saved splits) as visible, testable UI. Running parallel to 04-03 — no shared files.
Output: HistorySection.tsx component, HistorySection.test.tsx with passing tests, App.tsx updated to mount HistorySection.
</objective>

<execution_context>
@C:/Users/Kiet Dinh/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Kiet Dinh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-persistence/04-RESEARCH.md
@.planning/phases/04-persistence/04-01-SUMMARY.md
@gsd-module-test/src/store/historyStore.ts
@gsd-module-test/src/store/billStore.ts
@gsd-module-test/src/App.tsx
@gsd-module-test/src/components/PeopleSection.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HistorySection component</name>
  <files>gsd-module-test/src/components/HistorySection.tsx</files>
  <action>
Create gsd-module-test/src/components/HistorySection.tsx following the structural pattern in 04-RESEARCH.md "HistorySection Component" section.

Implementation requirements:

1. Import `useShallow` from `'zustand/shallow'`
2. Import `useHistoryStore` and `SavedSplit` type from `'../store/historyStore'`
3. Import `useBillStore` from `'../store/billStore'`

4. `handleLoad(split: SavedSplit)` function:
   - Check if current bill has data: `const s = useBillStore.getState(); const hasBillData = s.people.length > 0 || s.items.length > 0`
   - If `hasBillData`, show `window.confirm('Loading this split will replace your current bill. Continue?')`. If user cancels (returns false), return early.
   - Call `useBillStore.setState({ people, items, assignments, tipPercent, tipSplitMode, taxMode, taxValue, taxSplitMode })` using split's data fields

5. Empty state: when `savedSplits.length === 0`, render `<section>` with heading "History" and paragraph "No saved splits yet"

6. List state: when `savedSplits.length > 0`, render `<section>` with heading "History" and a `<ul>` of entries. Each `<li>` contains:
   - Split name in `<span>`
   - Formatted date: `new Date(split.savedAt).toLocaleDateString()` in a smaller `<span>`
   - "Load" `<button>` calling `handleLoad(split)`
   - "Delete" `<button>` calling `deleteSplit(split.id)`

7. Apply Tailwind classes consistent with existing sections: `rounded-lg bg-white p-6 shadow-sm` on `<section>`, `text-lg font-semibold text-gray-900 mb-4` on heading, `space-y-2` on list, `flex items-center justify-between rounded-md bg-gray-50 px-3 py-2` on list items

8. Load button: `text-sm text-blue-600 hover:text-blue-700 focus:outline-none`
   Delete button: `text-sm font-medium text-red-600 hover:text-red-700 focus:outline-none`

9. Use `useShallow` for the store selector: `useHistoryStore(useShallow((s) => ({ savedSplits: s.savedSplits, deleteSplit: s.deleteSplit })))`
  </action>
  <verify>
`npx tsc --noEmit` from gsd-module-test directory — 0 errors on HistorySection.tsx
  </verify>
  <done>
- HistorySection.tsx exists and exports `HistorySection`
- Empty state renders "No saved splits yet" when savedSplits is empty
- List renders split name + date + Load + Delete buttons when savedSplits has entries
- handleLoad checks for existing bill data before loading
- TypeScript compiles with 0 errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Write HistorySection tests and update App.tsx</name>
  <files>
    gsd-module-test/src/components/HistorySection.test.tsx
    gsd-module-test/src/App.tsx
  </files>
  <action>
**Part A — HistorySection.test.tsx:**

Create gsd-module-test/src/components/HistorySection.test.tsx with the following structure:

```
// @vitest-environment jsdom
import { afterEach, beforeEach, describe, expect, it, vi } from 'vitest'
import { render, screen, cleanup } from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import { HistorySection } from './HistorySection'
import { useHistoryStore } from '../store/historyStore'
import { useBillStore } from '../store/billStore'
```

Setup (beforeEach): Call `localStorage.clear()`, `useHistoryStore.setState({ savedSplits: [] })`, and reset useBillStore to empty state.
Teardown: `afterEach(cleanup)`

Helper `seedSplit(name: string)`: calls `useHistoryStore.getState().saveSplit({ name, people: [], items: [], assignments: [], tipPercent: 0, tipSplitMode: 'equal', taxMode: 'amount', taxValue: 0, taxSplitMode: 'equal' })`

Test cases (all in `describe('HistorySection', ...)`):

1. `'shows "No saved splits yet" when history is empty'` — render, expect text present
2. `'shows saved split name when history has entries'` — seedSplit('Friday dinner'), render, expect 'Friday dinner' present
3. `'shows saved date for each entry'` — seedSplit, render, expect `toLocaleDateString()` output visible (use `screen.getByText` with regex matching date format OR check for a date-like string via `getAllByText`)
4. `'clicking Delete removes the entry'` — seedSplit('Dinner'), render, click Delete button, expect 'Dinner' NOT in document
5. `'clicking Load calls useBillStore.setState with the split data'` — spy on `useBillStore.setState` with `vi.spyOn(useBillStore, 'setState')`, seedSplit with non-empty people data (e.g. `people: [{ id: 'p1', name: 'Alice' }]`), render, click Load (no confirm needed since bill is empty), check spy was called
6. `'clicking Load on an entry when bill has data shows confirm dialog'` — `vi.spyOn(window, 'confirm').mockReturnValue(false)`, set useBillStore with one person, seedSplit, render, click Load, expect confirm was called
7. `'clicking Load when confirm returns false does not update bill store'` — confirm mocked to return false, spy on useBillStore.setState, verify setState NOT called after Load click

**Part B — App.tsx:**

Add `import { HistorySection } from './components/HistorySection'` to the imports.
Add `<HistorySection />` after `<ResultsSection />` inside the space-y-6 div.
  </action>
  <verify>
From gsd-module-test directory:
```
npx vitest run
```
All tests must pass. Count should be 128 (existing) + 7 (new HistorySection tests) = 135+.
  </verify>
  <done>
- HistorySection.test.tsx exists with 7+ tests all passing
- App.tsx imports and renders HistorySection after ResultsSection
- `npx vitest run` exits 0 with all tests passing
- `npx tsc --noEmit` exits 0
  </done>
</task>

</tasks>

<verification>
From gsd-module-test directory:
1. `npx tsc --noEmit` — 0 type errors
2. `npx vitest run` — all tests pass (135+)
3. `grep -n "HistorySection" gsd-module-test/src/App.tsx` — shows import and JSX usage
4. `grep -n "confirm" gsd-module-test/src/components/HistorySection.tsx` — shows window.confirm guard for load
</verification>

<success_criteria>
- HistorySection shows empty state when no history, list when history exists
- Load button loads split into bill store (with confirm guard when bill has data)
- Delete button removes entry immediately
- All tests pass, 0 type errors
- HistorySection mounted in App.tsx
</success_criteria>

<output>
After completion, create `.planning/phases/04-persistence/04-02-SUMMARY.md`
</output>
