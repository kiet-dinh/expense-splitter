---
phase: 04-persistence
plan: 3
type: execute
wave: 2
depends_on:
  - 04-01
files_modified:
  - gsd-module-test/src/components/ResultsSection.tsx
  - gsd-module-test/src/components/ResultsSection.test.tsx
  - gsd-module-test/src/components/PeopleSection.tsx
  - gsd-module-test/src/components/PeopleSection.test.tsx
autonomous: true
requirements:
  - PERSIST-01
  - PEOPLE-04

must_haves:
  truths:
    - "A 'Save Split' button appears in ResultsSection when there is at least one person in the bill"
    - "Clicking 'Save Split' opens an inline name input; typing a name and confirming calls useHistoryStore.saveSplit() with all bill data fields"
    - "Submitting an empty name does nothing (save is disabled/no-op until name is non-empty)"
    - "On storage quota error (QuotaExceededError), an alert is shown to the user"
    - "Suggestion chips appear in PeopleSection when history contains names not already in the current bill"
    - "Clicking a suggestion chip adds that person to the bill immediately"
    - "Chips do not appear for names already present in the current bill (case-insensitive)"
  artifacts:
    - path: "gsd-module-test/src/components/ResultsSection.tsx"
      provides: "Save Split button + inline name input dialog that calls useHistoryStore.saveSplit()"
    - path: "gsd-module-test/src/components/ResultsSection.test.tsx"
      provides: "Tests for Save button visibility, dialog open/close, save call, empty-name guard"
    - path: "gsd-module-test/src/components/PeopleSection.tsx"
      provides: "PEOPLE-04 suggestion chips from history names not in current bill"
    - path: "gsd-module-test/src/components/PeopleSection.test.tsx"
      provides: "Tests for chip appearance, chip click adding person, deduplication filter"
  key_links:
    - from: "gsd-module-test/src/components/ResultsSection.tsx"
      to: "gsd-module-test/src/store/historyStore.ts"
      via: "useHistoryStore for saveSplit action"
      pattern: "useHistoryStore"
    - from: "gsd-module-test/src/components/ResultsSection.tsx"
      to: "gsd-module-test/src/store/billStore.ts"
      via: "useBillStore.getState() to snapshot all data fields at save time"
      pattern: "useBillStore\\.getState"
    - from: "gsd-module-test/src/components/PeopleSection.tsx"
      to: "gsd-module-test/src/store/historyStore.ts"
      via: "useHistoryStore for savedSplits to derive suggestions"
      pattern: "useHistoryStore"
---

<objective>
Add the Save Split trigger in ResultsSection and the PEOPLE-04 quick-add suggestion chips in PeopleSection.

Purpose: PERSIST-01 requires both a data layer (04-01) and a UI trigger (this plan). PEOPLE-04 is a small enhancement to PeopleSection that reads from historyStore. Both are UI-only changes to existing components — no shared files with 04-02, so they run in parallel.
Output: ResultsSection with save flow, PeopleSection with history-based suggestion chips, and updated tests for both.
</objective>

<execution_context>
@C:/Users/Kiet Dinh/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Kiet Dinh/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-persistence/04-RESEARCH.md
@.planning/phases/04-persistence/04-01-SUMMARY.md
@gsd-module-test/src/store/historyStore.ts
@gsd-module-test/src/store/billStore.ts
@gsd-module-test/src/components/ResultsSection.tsx
@gsd-module-test/src/components/ResultsSection.test.tsx
@gsd-module-test/src/components/PeopleSection.tsx
@gsd-module-test/src/components/PeopleSection.test.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Save Split flow to ResultsSection</name>
  <files>
    gsd-module-test/src/components/ResultsSection.tsx
    gsd-module-test/src/components/ResultsSection.test.tsx
  </files>
  <action>
**Part A — ResultsSection.tsx:**

Add save-split functionality to the existing ResultsSection component. Do not break any existing behavior (copy summary, itemized breakdown, verification line).

1. Add imports at the top:
   - `useHistoryStore` from `'../store/historyStore'`
   (useBillStore is already imported; keep existing imports)

2. Add state inside the component:
   ```
   const [showSaveDialog, setShowSaveDialog] = useState(false)
   const [saveName, setSaveName] = useState('')
   ```

3. Add store selector for saveSplit:
   ```
   const { saveSplit } = useHistoryStore(useShallow((s) => ({ saveSplit: s.saveSplit })))
   ```

4. Add `handleSave()` function:
   - Trim saveName; if empty, return early
   - Call `const s = useBillStore.getState()`
   - Wrap in try/catch:
     - try: call `saveSplit({ name: trimmedName, people: s.people, items: s.items, assignments: s.assignments, tipPercent: s.tipPercent, tipSplitMode: s.tipSplitMode, taxMode: s.taxMode, taxValue: s.taxValue, taxSplitMode: s.taxSplitMode })`
     - On success: `setSaveName('')`, `setShowSaveDialog(false)`
     - catch: `alert('Could not save: browser storage is full.')`

5. In the JSX header row (already contains "Copy Summary" button), add a "Save Split" button next to Copy Summary:
   - Only render when `people.length > 0` (same condition as Copy Summary)
   - `onClick={() => setShowSaveDialog(true)}`
   - Styling: `rounded-md bg-green-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2`
   - aria-label: `'Save this split'`

6. Add inline save dialog (renders below the header row when showSaveDialog is true):
   ```jsx
   {showSaveDialog && (
     <div className="mb-4 flex gap-2 items-center" role="form" aria-label="Save split">
       <input
         type="text"
         value={saveName}
         onChange={(e) => setSaveName(e.target.value)}
         onKeyDown={(e) => { if (e.key === 'Enter') handleSave(); if (e.key === 'Escape') setShowSaveDialog(false) }}
         placeholder="Name this split (e.g. Friday dinner)"
         className="flex-1 rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-green-500 focus:outline-none focus:ring-1 focus:ring-green-500"
         autoFocus
       />
       <button
         onClick={handleSave}
         disabled={saveName.trim().length === 0}
         className="rounded-md bg-green-600 px-3 py-1.5 text-sm font-medium text-white hover:bg-green-700 disabled:opacity-50 focus:outline-none"
         aria-label="Confirm save"
       >
         Save
       </button>
       <button
         onClick={() => { setShowSaveDialog(false); setSaveName('') }}
         className="rounded-md bg-gray-200 px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-300 focus:outline-none"
         aria-label="Cancel save"
       >
         Cancel
       </button>
     </div>
   )}
   ```

**Part B — ResultsSection.test.tsx:**

Add new test cases to the existing test file. Preserve all 128 existing tests. Add at the end of the describe block:

Setup additions in the existing beforeEach (or a new nested describe with its own beforeEach):
- `localStorage.clear()`
- `useHistoryStore.setState({ savedSplits: [] })`
- Import `useHistoryStore` from `'../store/historyStore'`

New tests (add in a nested `describe('Save Split', ...)` block):

1. `'shows Save Split button when people exist'` — render, expect button with aria-label 'Save this split' is in document
2. `'does not show Save Split button when no people'` — resetStore(), render, expect button NOT in document
3. `'clicking Save Split button shows the save dialog'` — click 'Save this split' button, expect input with placeholder 'Name this split' is visible
4. `'Cancel button closes the save dialog'` — open dialog, click Cancel, expect dialog input gone
5. `'Save button is disabled when name is empty'` — open dialog, expect Confirm save button is disabled
6. `'typing a name and clicking Save calls saveSplit with correct data'` — spy on `useHistoryStore.getState().saveSplit` (or check savedSplits after), type 'Friday dinner', click Save (aria-label 'Confirm save'), verify `useHistoryStore.getState().savedSplits` has one entry with name 'Friday dinner' and people/items matching store state
7. `'successful save closes the dialog and clears the name input'` — type name, click Save, expect dialog input gone
  </action>
  <verify>
From gsd-module-test directory:
```
npx vitest run --reporter=verbose 2>&1 | grep -E "(PASS|FAIL|ResultsSection)"
```
All ResultsSection tests pass. `npx tsc --noEmit` exits 0.
  </verify>
  <done>
- ResultsSection shows "Save Split" button when people.length > 0
- Clicking it shows inline name input
- Typing name and confirming calls saveSplit with all bill fields
- Empty name prevents save
- Cancel closes dialog
- All 7 new save tests pass
- All existing ResultsSection tests still pass
- 0 TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add PEOPLE-04 quick-add suggestion chips to PeopleSection</name>
  <files>
    gsd-module-test/src/components/PeopleSection.tsx
    gsd-module-test/src/components/PeopleSection.test.tsx
  </files>
  <action>
**Part A — PeopleSection.tsx:**

Modify gsd-module-test/src/components/PeopleSection.tsx to implement PEOPLE-04 suggestion chips.

1. Add imports at the top:
   - `useHistoryStore` from `'../store/historyStore'`
   (useShallow and useBillStore are already imported; keep them)

2. Add store selector inside the component:
   ```
   const { savedSplits } = useHistoryStore(useShallow((s) => ({ savedSplits: s.savedSplits })))
   ```

3. Derive suggestion list after the existing `isDuplicate` calculation:
   ```typescript
   const currentNames = new Set(people.map((p) => p.name.toLowerCase()))
   const suggestions = Array.from(
     new Set(
       savedSplits.flatMap((split) => split.people.map((p) => p.name))
     )
   ).filter((name) => !currentNames.has(name.toLowerCase()))
   ```

4. Add suggestion chips JSX after the form and before the people list (only render when `suggestions.length > 0`):
   ```jsx
   {suggestions.length > 0 && (
     <div className="mt-3" aria-label="Suggestions from previous splits">
       <p className="text-xs text-gray-500 mb-1">From previous splits:</p>
       <div className="flex flex-wrap gap-1">
         {suggestions.map((name) => (
           <button
             key={name}
             type="button"
             onClick={() => addPerson(name)}
             className="rounded-full bg-blue-50 px-3 py-1 text-xs font-medium text-blue-700 hover:bg-blue-100 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
             aria-label={`Add ${name} from previous split`}
           >
             {name}
           </button>
         ))}
       </div>
     </div>
   )}
   ```

5. Remove the PEOPLE-04 deferred comment at the top of the file.

**Part B — PeopleSection.test.tsx:**

Add new test cases to the existing PeopleSection test file. Preserve all existing tests.

Setup: Add to the existing beforeEach (or a new nested describe's beforeEach):
- `localStorage.clear()`
- `useHistoryStore.setState({ savedSplits: [] })`
- Import `useHistoryStore` from `'../store/historyStore'`

Helper `seedHistory(names: string[])`: calls `useHistoryStore.getState().saveSplit({ name: 'Test', people: names.map((n, i) => ({ id: String(i), name: n })), items: [], assignments: [], tipPercent: 0, tipSplitMode: 'equal', taxMode: 'amount', taxValue: 0, taxSplitMode: 'equal' })`

New tests (in a nested `describe('PEOPLE-04 suggestion chips', ...)` block):

1. `'shows no suggestion chips when history is empty'` — render, expect no element with aria-label matching /Add .* from previous split/
2. `'shows suggestion chips for names in history not already in bill'` — seedHistory(['Alice', 'Bob']), render, expect chip for 'Alice' and 'Bob' visible
3. `'does not show chip for name already in current bill (case-insensitive)'` — seedHistory(['Alice']), add Alice to store, render, expect no chip with aria-label 'Add Alice from previous split'
4. `'clicking a suggestion chip adds the person to the bill'` — seedHistory(['Alice']), render, click chip 'Add Alice from previous split', check that useBillStore.getState().people contains a person named 'Alice'
5. `'chip disappears after clicking it (person now in bill)'` — seedHistory(['Alice']), click chip, expect chip is no longer visible
  </action>
  <verify>
From gsd-module-test directory:
```
npx vitest run
```
All tests pass. `npx tsc --noEmit` exits 0.
  </verify>
  <done>
- PeopleSection shows suggestion chips when history has names not in current bill
- Chips are filtered to exclude names already in the bill (case-insensitive)
- Clicking a chip calls addPerson with the chip's name
- All 5 new PeopleSection tests pass
- All existing PeopleSection tests still pass
- 0 TypeScript errors
  </done>
</task>

</tasks>

<verification>
From gsd-module-test directory:
1. `npx tsc --noEmit` — 0 type errors
2. `npx vitest run` — all tests pass (expected total: 128 existing + 7 ResultsSection save tests + 5 PeopleSection chip tests = 140+)
3. `grep -n "useHistoryStore" gsd-module-test/src/components/ResultsSection.tsx` — shows import and selector
4. `grep -n "suggestions" gsd-module-test/src/components/PeopleSection.tsx` — shows suggestion derivation logic
5. `grep -n "Save Split" gsd-module-test/src/components/ResultsSection.tsx` — shows button text
</verification>

<success_criteria>
- ResultsSection has Save Split button that opens inline name dialog; save calls historyStore.saveSplit() with all bill fields
- PeopleSection shows clickable history-name chips filtered to exclude current bill members
- All tests pass, 0 type errors
- No regressions in existing 128 tests
</success_criteria>

<output>
After completion, create `.planning/phases/04-persistence/04-03-SUMMARY.md`
</output>
